#!/bin/sh
# preinst script for sharkey.
#
# See: dh_installdeb(1).

set -e

# Summary of how this script can be called:
#        * <new-preinst> 'install'
#        * <new-preinst> 'install' <old-version>
#        * <new-preinst> 'upgrade' <old-version>
#        * <old-preinst> 'abort-upgrade' <new-version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package.

USER=sharkey
GROUP="$USER"
CONFFILE=/etc/sharkey/default.yml
DATADIR=/var/lib/sharkey

case "$1" in
    configure)
        # Add service user
        if ! getent group "$GROUP" >/dev/null; then
            groupadd --system "$GROUP"
        fi
        if ! getent passwd "$USER" >/dev/null; then
            useradd --system \
                --gid "$GROUP" \
                --create-home \
                --home-dir "$DATADIR/work" \
                --shell /usr/sbin/nologin \
                --comment "Sharkey daemon" \
                "$USER"
        fi

        if [ ! -d "$DATADIR" ]; then
            mkdir -p "$DATADIR"
            chown "$USER:$GROUP" "$DATADIR"
        fi

        # handle cases where package was installed and then purged;
        # user and group will still exist but with no home dir
        if [ ! -d "$DATADIR/work" ]; then
            mkdir -p "$DATADIR/work"
            chown "$USER:$GROUP" "$DATADIR/work"
        fi

        if [ ! -d "$DATADIR/files" ]; then
            mkdir -p "$DATADIR/files"
            chown "$USER:$GROUP" "$DATADIR/files"
        fi
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument '$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
